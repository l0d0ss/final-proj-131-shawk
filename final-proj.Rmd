---
title: "final project"
author: "Katlyn Shaw"
date: "2022-11-28"
output: html_document
---

```{r setup, include=FALSE}
# load packages
library(glmnet)
library(janitor)
library(corrplot)
library(rpart.plot)
library(vip)
library(randomForest)
library(xgboost)
library(tidyverse)
library(tidymodels)
library(ranger)
library(discrim)
library(poissonreg)
library(corrr)
library(klaR)
library(yardstick)
tidymodels_prefer()
```

```{r}
# load data
seoul_bike <- read.csv("/Users/katlynshaw/Desktop/pstat 131/final-proj-131-shawk/SeoulBikeDataColNameFIXED.csv") %>% 
  clean_names() %>% 
  mutate(date = as.Date(date, "%d/%m/%Y"),
         time_of_day = factor(ifelse(hour < 6, "Night", ifelse(hour < 12, "Morning", ifelse(hour < 18, "Afternoon", ifelse(hour < 24, "Evening", "Null")))), levels = c("Night", "Morning", "Afternoon", "Evening")),
         hour = factor(hour, levels = c(0:23)),
         seasons = factor(seasons, levels = c("Winter", "Spring", "Summer", "Autumn")),
         holiday = factor(holiday, levels = c("Holiday", "No Holiday")),
         functioning_day = factor(functioning_day, levels = c("Yes", "No")),
         weekday = factor(lubridate::wday(date), levels = c(1:7)),
         workday = factor(ifelse(weekday != 1 & weekday != 7, "Yes", "No"), levels = c("Yes", "No")),
         goodweather = factor(ifelse(rainfall == 0.0 & snowfall == 0.0, "Yes", "No"), levels = c("Yes", "No"))
         #percent_of_mean = rented_bike_count / mean(seoul_bike$rented_bike_count)
         )
```

```{r}
# split data

set.seed(151020)

seoul_bike_split <- seoul_bike %>% 
  initial_split(prop = 0.8)

bike_train <- training(seoul_bike_split)
bike_test <- testing(seoul_bike_split)

```


Columns list: Date mm/dd/yyyy, Rented Bike Count, Hour, Temperature (Celsius), Humidity (%), Wind Speed (m/s), Visibility (10m), Dew point temperature (Celsius), Solar Radiation (MJ/m2), Rainfall (mm), Snowfall (cm), Seasons, Holiday, Functioning Day, weekday (1=sunday, 2=monday, etc), workday assumes a 5 day workweek from mon-fri returns Yes for weekday and No for weekend

Data goes from 12/1/2017 to 11/30/2018 which is 1 full year.

exploratory questions:

What's the most popular day to rent bikes? Month? Season? Hour?


```{r}

bike_train %>% 
  ggplot(aes(date, rented_bike_count)) + geom_point() + geom_smooth()

bike_train %>% 
  ggplot(aes(seasons, rented_bike_count)) + geom_col()

bike_train %>% 
  ggplot(aes(weekday, rented_bike_count)) + geom_col()

bike_train %>% 
  ggplot(aes(hour, rented_bike_count)) + geom_col()

bike_train %>% 
  ggplot(aes(time_of_day, rented_bike_count)) + geom_col()

bike_train %>% 
  ggplot(aes(rented_bike_count, humidity)) + geom_point() + geom_smooth(method = "lm")

bike_train %>% filter(rainfall != 0.0) %>% 
  ggplot(aes(rainfall, rented_bike_count)) + geom_point() + geom_smooth(method = "lm")

bike_train %>% filter(snowfall != 0.0) %>%
  ggplot(aes(snowfall, rented_bike_count)) + geom_point() + geom_smooth(method = "lm")

bike_train %>% 
  ggplot(aes(temperature, rented_bike_count)) + geom_point() + geom_smooth()

bike_train %>% 
  select(where(is.numeric)) %>% 
  cor(use="pairwise.complete.obs") %>% 
  corrplot(type = 'lower', diag = FALSE, method = 'color')

```

```{r}
# letsa get cookin
bikes_recipe <- recipe(rented_bike_count ~
                         hour +
                         temperature +
                         humidity +
                         wind_speed +
                         visibility +
                         dew_point_temperature +
                         solar_radiation +
                         rainfall +
                         snowfall +
                         seasons +
                         holiday +
                         functioning_day,
                       data = bike_train) %>% 
  step_dummy(hour, seasons, holiday, functioning_day) %>% 
  step_normalize(all_predictors())

```

```{r}

lm_model <- linear_reg() %>% 
  set_engine("lm")

lm_workflow <- workflow() %>% 
  add_model(lm_model) %>% 
  add_recipe(bikes_recipe)

lm_fit <- fit(lm_workflow, bike_train)

lm_fit %>%
  extract_fit_parsnip() %>% 
  tidy()

bike_train_res <- predict(lm_fit, new_data = bike_train %>% select(-rented_bike_count)) %>% 
  bind_cols(bike_train %>% select(rented_bike_count))

bike_train_res %>% 
  head()

bike_train_res %>% 
  ggplot(aes(x = .pred, y = rented_bike_count)) +
  geom_point(alpha = 0.2) +
  geom_abline(lty = 2) + 
  theme_bw() +
  coord_obs_pred()

bike_metrics <- metric_set(rmse, rsq, mae)
bike_metrics(bike_train_res, truth = rented_bike_count, estimate = .pred)

```





